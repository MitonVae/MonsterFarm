<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ªå…½å†œåœº - æŒ‚æœºç»è¥æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #f5f5f5;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .resources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .resource {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .resource-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .resource-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* å†œåœºæ ·å¼ */
        .farm-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .plot {
            aspect-ratio: 1;
            background: #d7ccc8;
            border-radius: 12px;
            border: 3px solid #8d6e63;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            padding: 10px;
        }
        
        .plot:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .plot.locked {
            background: #424242;
            border-color: #212121;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .plot.planted {
            background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%);
            border-color: #66bb6a;
        }
        
        .plot-icon {
            margin-bottom: 8px;
        }
        
        .plot-text {
            font-size: 11px;
            text-align: center;
            color: #333;
        }
        
        .progress-bar {
            width: 90%;
            height: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s;
        }
        
        /* æ€ªå…½æ ·å¼ */
        .monster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .monster-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .monster-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .monster-card.working {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
        }
        
        .monster-card.selected {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border-color: #ffc107;
        }
        
        .monster-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .monster-icon-container {
            margin-right: 12px;
        }
        
        .monster-info {
            flex: 1;
        }
        
        .monster-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .monster-type {
            font-size: 11px;
            color: #666;
            display: inline-block;
            padding: 2px 8px;
            background: #e0e0e0;
            border-radius: 10px;
        }
        
        .monster-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            font-size: 11px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
        }
        
        /* çŸ¢é‡å›¾æ ‡ */
        .svg-icon {
            width: 48px;
            height: 48px;
        }
        
        .svg-icon-sm {
            width: 24px;
            height: 24px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ç§‘æŠ€æ ‘ */
        .tech-tree {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .tech-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #ddd;
            position: relative;
        }
        
        .tech-item.unlocked {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }
        
        .tech-item.locked {
            opacity: 0.6;
        }
        
        .tech-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tech-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .tech-cost {
            font-size: 11px;
            color: #f57c00;
            margin-bottom: 10px;
        }
        
        /* æ¢ç´¢ç•Œé¢ */
        .exploration-area {
            background: white;
            padding: 20px;
            border-radius: 15px;
        }
        
        .expedition-panel {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .expedition-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .expedition-slot {
            aspect-ratio: 1;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .expedition-slot:hover {
            border-color: #667eea;
            background: #f0f0f0;
        }
        
        .expedition-slot.filled {
            border-style: solid;
            border-color: #4caf50;
        }
        
        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
            max-width: 300px;
            border-left: 4px solid #667eea;
        }
        
        .notification.success {
            border-left-color: #4caf50;
        }
        
        .notification.warning {
            border-left-color: #ff9800;
        }
        
        .notification.error {
            border-left-color: #f44336;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalIn 0.3s;
        }
        
        @keyframes modalIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons .btn {
            flex: 1;
        }
        
        /* äº‹ä»¶é¢æ¿ */
        .event-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            max-width: 350px;
            border-left: 4px solid #ff9800;
            z-index: 999;
            animation: slideInLeft 0.3s;
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .event-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff9800;
        }
        
        .event-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .event-choices {
            display: flex;
            gap: 10px;
        }
        
        .event-choices .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }
        
        /* ç¹æ®–ç•Œé¢ */
        .breeding-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
        }
        
        .breeding-slots {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
        }
        
        .breeding-slot {
            background: #f5f5f5;
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .breeding-slot:hover {
            border-color: #667eea;
            background: #e8eaf6;
        }
        
        .breeding-slot.filled {
            border-style: solid;
            border-color: #4caf50;
        }
        
        .breeding-arrow {
            font-size: 24px;
            color: #999;
        }
        
        /* å¤„ç†ç•Œé¢ */
        .disposal-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
        }
        
        .disposal-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .disposal-option {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #ddd;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .disposal-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .disposal-title {
            font-weight: bold;
            margin: 10px 0;
        }
        
        .disposal-desc {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ­ æ€ªå…½å†œåœº</h1>
            <p>åŸ¹è‚²æ€ªå…½ï¼Œç»è¥å†œåœºï¼Œæ¢ç´¢æœªçŸ¥ä¸–ç•Œ</p>
        </div>
        
        <div class="resources" id="resources"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('farm')">å†œåœº</button>
            <button class="tab" onclick="switchTab('monsters')">æ€ªå…½</button>
            <button class="tab" onclick="switchTab('exploration')">æ¢ç´¢</button>
            <button class="tab" onclick="switchTab('breeding')">ç¹æ®–</button>
            <button class="tab" onclick="switchTab('tech')">ç§‘æŠ€</button>
            <button class="tab" onclick="switchTab('disposal')">å¤„ç†</button>
        </div>
        
        <div id="farm-tab" class="tab-content active">
            <div class="farm-container">
                <h2>å†œåœºç®¡ç†</h2>
                <div class="farm-grid" id="farmGrid"></div>
            </div>
        </div>
        
        <div id="monsters-tab" class="tab-content">
            <div class="farm-container">
                <h2>æ€ªå…½ç®¡ç† <span style="font-size: 14px; color: #666;">(ç‚¹å‡»é€‰æ‹©æ€ªå…½è¿›è¡Œåˆ†é…)</span></h2>
                <div style="margin: 15px 0;">
                    <button class="btn btn-primary" onclick="showRecruitModal()">æ‹›å‹Ÿæ€ªå…½</button>
                </div>
                <div class="monster-grid" id="monsterGrid"></div>
            </div>
        </div>
        
        <div id="exploration-tab" class="tab-content">
            <div class="exploration-area" id="explorationArea"></div>
        </div>
        
        <div id="breeding-tab" class="tab-content">
            <div class="breeding-container" id="breedingContainer"></div>
        </div>
        
        <div id="tech-tab" class="tab-content">
            <div class="farm-container">
                <h2>ç§‘æŠ€æ ‘</h2>
                <div class="tech-tree" id="techTree"></div>
            </div>
        </div>
        
        <div id="disposal-tab" class="tab-content">
            <div class="disposal-container" id="disposalContainer"></div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            coins: 100,
            food: 50,
            materials: 0,
            research: 0,
            energy: 100,
            maxEnergy: 100,
            
            plots: [],
            monsters: [],
            expeditions: [],
            
            selectedMonster: null,
            
            technologies: {},
            
            nextMonsterId: 1,
            
            // ç»Ÿè®¡æ•°æ®
            totalHarvests: 0,
            totalExplorations: 0,
            monstersBreed: 0
        };
        
        // æ€ªå…½ç±»å‹å®šä¹‰
        const monsterTypes = {
            slime: { name: 'å²è±å§†', color: '#4caf50', baseStats: { strength: 3, agility: 2, intelligence: 1, farming: 4 } },
            goblin: { name: 'å“¥å¸ƒæ—', color: '#ff9800', baseStats: { strength: 4, agility: 3, intelligence: 2, farming: 2 } },
            sprite: { name: 'ç²¾çµ', color: '#2196f3', baseStats: { strength: 1, agility: 4, intelligence: 5, farming: 3 } },
            golem: { name: 'çŸ³åƒé¬¼', color: '#795548', baseStats: { strength: 5, agility: 1, intelligence: 1, farming: 3 } },
            wisp: { name: 'å¹½çµ', color: '#9c27b0', baseStats: { strength: 2, agility: 5, intelligence: 4, farming: 1 } }
        };
        
        // ä½œç‰©ç±»å‹
        const cropTypes = [
            { id: 'wheat', name: 'å°éº¦', growTime: 15000, yield: 5, value: 8, requiredTech: null },
            { id: 'corn', name: 'ç‰ç±³', growTime: 25000, yield: 8, value: 15, requiredTech: null },
            { id: 'potato', name: 'åœŸè±†', growTime: 20000, yield: 10, value: 10, requiredTech: null },
            { id: 'berry', name: 'æµ†æœ', growTime: 30000, yield: 12, value: 25, requiredTech: 'advancedFarming' }
        ];
        
        // ç§‘æŠ€æ ‘
        const technologies = {
            advancedFarming: {
                name: 'é«˜çº§å†œä¸š',
                desc: 'è§£é”é«˜çº§ä½œç‰©å’Œè€•ä½œæŠ€æœ¯',
                cost: { research: 50, coins: 200 },
                unlocked: false,
                effects: { cropYield: 1.2 }
            },
            irrigation: {
                name: 'çŒæº‰ç³»ç»Ÿ',
                desc: 'å‡å°‘ä½œç‰©ç”Ÿé•¿æ—¶é—´20%',
                cost: { research: 30, materials: 50 },
                unlocked: false,
                effects: { growthSpeed: 1.25 }
            },
            monsterTraining: {
                name: 'æ€ªå…½è®­ç»ƒ',
                desc: 'æå‡æ€ªå…½å±æ€§æˆé•¿',
                cost: { research: 80, coins: 300 },
                unlocked: false,
                effects: { statGrowth: 1.3 }
            },
            exploration: {
                name: 'æ¢ç´¢æŠ€æœ¯',
                desc: 'å¢åŠ æ¢ç´¢æ”¶ç›Šå’ŒæˆåŠŸç‡',
                cost: { research: 60, materials: 100 },
                unlocked: false,
                effects: { explorationBonus: 1.5 }
            },
            breeding: {
                name: 'ç¹æ®–æŠ€æœ¯',
                desc: 'å…è®¸æ€ªå…½ç¹æ®–ï¼ŒåŸ¹è‚²æ›´å¼ºåä»£',
                cost: { research: 100, coins: 500 },
                unlocked: false,
                effects: { breedingEnabled: true }
            },
            expansion: {
                name: 'å†œåœºæ‰©å»º',
                desc: 'è§£é”æ›´å¤šå†œç”°',
                cost: { coins: 500, materials: 200 },
                unlocked: false,
                effects: { extraPlots: 3 }
            }
        };
        
        // éšæœºäº‹ä»¶æ± 
        const randomEvents = {
            farming: [
                {
                    title: 'ğŸŒ§ï¸ åŠæ—¶é›¨',
                    desc: 'ä¸€åœºåŠæ—¶é›¨é™ä¸´å†œåœºï¼Œä½œç‰©ç”Ÿé•¿é€Ÿåº¦ä¸´æ—¶æå‡ï¼',
                    choices: [
                        { text: 'å¤ªå¥½äº†ï¼', effect: () => {
                            gameState.plots.forEach(plot => {
                                if (plot.crop) plot.growthBonus = 1.5;
                            });
                            setTimeout(() => {
                                gameState.plots.forEach(plot => plot.growthBonus = 1);
                            }, 30000);
                            showNotification('ä½œç‰©ç”Ÿé•¿åŠ é€Ÿ30ç§’ï¼', 'success');
                        }}
                    ]
                },
                {
                    title: 'ğŸ› è™«å®³',
                    desc: 'å†œåœºé­é‡è™«å®³ï¼æ˜¯å¦ä½¿ç”¨é£Ÿç‰©é©±è™«ï¼Ÿ',
                    choices: [
                        { 
                            text: 'ä½¿ç”¨é£Ÿç‰©(20)', 
                            cost: { food: 20 },
                            effect: () => showNotification('æˆåŠŸé©±è™«ï¼', 'success')
                        },
                        { 
                            text: 'å¿½ç•¥', 
                            effect: () => {
                                const plot = gameState.plots.find(p => p.crop);
                                if (plot) {
                                    plot.progress = Math.max(0, plot.progress - 30);
                                    showNotification('ä½œç‰©ç”Ÿé•¿å—æŸ...', 'error');
                                }
                            }
                        }
                    ]
                },
                {
                    title: 'ğŸ’¨ å¤§é£',
                    desc: 'å¤§é£å¹è¿‡å†œåœºï¼Œæ•£è½äº†ä¸€äº›ææ–™',
                    choices: [
                        { text: 'æ”¶é›†', effect: () => {
                            const gain = Math.floor(Math.random() * 20) + 10;
                            gameState.materials += gain;
                            updateResources();
                            showNotification(`è·å¾— ${gain} ææ–™ï¼`, 'success');
                        }}
                    ]
                }
            ],
            exploration: [
                {
                    title: 'ğŸ—ºï¸ ç¥ç§˜å•†äºº',
                    desc: 'é‡åˆ°ç¥ç§˜å•†äººï¼Œæ„¿æ„ç”¨ææ–™äº¤æ¢é‡‘å¸',
                    choices: [
                        { 
                            text: 'äº¤æ˜“(ææ–™-50 â†’ é‡‘å¸+150)', 
                            cost: { materials: 50 },
                            effect: () => {
                                gameState.coins += 150;
                                updateResources();
                                showNotification('äº¤æ˜“æˆåŠŸï¼', 'success');
                            }
                        },
                        { text: 'æ‹’ç»', effect: () => {} }
                    ]
                },
                {
                    title: 'âš”ï¸ é‡ç”Ÿæ€ªå…½',
                    desc: 'é­é‡é‡ç”Ÿæ€ªå…½ï¼æ˜¯å¦æˆ˜æ–—æ•è·ï¼Ÿ',
                    choices: [
                        { 
                            text: 'æˆ˜æ–—', 
                            effect: () => {
                                if (Math.random() > 0.5) {
                                    const types = Object.keys(monsterTypes);
                                    const type = types[Math.floor(Math.random() * types.length)];
                                    createMonster(type);
                                    showNotification('æ•è·æˆåŠŸï¼è·å¾—æ–°æ€ªå…½ï¼', 'success');
                                } else {
                                    gameState.energy = Math.max(0, gameState.energy - 20);
                                    updateResources();
                                    showNotification('æ•è·å¤±è´¥ï¼Œæ¶ˆè€—èƒ½é‡...', 'error');
                                }
                            }
                        },
                        { text: 'é€ƒè·‘', effect: () => {} }
                    ]
                },
                {
                    title: 'ğŸ’ å®è—',
                    desc: 'å‘ç°äº†ä¸€ä¸ªå®ç®±ï¼',
                    choices: [
                        { text: 'æ‰“å¼€', effect: () => {
                            const rewards = [
                                { coins: 100 },
                                { materials: 80 },
                                { research: 30 },
                                { food: 50 }
                            ];
                            const reward = rewards[Math.floor(Math.random() * rewards.length)];
                            Object.keys(reward).forEach(key => {
                                gameState[key] += reward[key];
                            });
                            updateResources();
                            showNotification('è·å¾—å¥–åŠ±ï¼š' + JSON.stringify(reward), 'success');
                        }}
                    ]
                }
            ],
            general: [
                {
                    title: 'ğŸ æ„å¤–ä¹‹è´¢',
                    desc: 'è·¯è¿‡çš„æ—…è¡Œè€…ç»™äº†ä½ ä¸€äº›é‡‘å¸',
                    choices: [
                        { text: 'æ”¶ä¸‹', effect: () => {
                            gameState.coins += 50;
                            updateResources();
                            showNotification('è·å¾— 50 é‡‘å¸ï¼', 'success');
                        }}
                    ]
                }
            ]
        };
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆ›å»ºåˆå§‹åœ°å—ï¼ˆ3å—å¯ç”¨ï¼Œå…¶ä»–é”å®šï¼‰
            for (let i = 0; i < 9; i++) {
                gameState.plots.push({
                    id: i,
                    locked: i >= 3,
                    unlockCost: { coins: 100 * (i - 2), materials: 50 * (i - 2) },
                    crop: null,
                    plantedAt: null,
                    progress: 0,
                    assignedMonster: null,
                    growthBonus: 1
                });
            }
            
            // åˆå§‹åŒ–ç§‘æŠ€
            Object.keys(technologies).forEach(key => {
                gameState.technologies[key] = false;
            });
            
            // åˆ›å»ºåˆå§‹æ€ªå…½
            createMonster('slime');
            
            renderAll();
            
            // å¯åŠ¨èƒ½é‡æ¢å¤
            setInterval(() => {
                if (gameState.energy < gameState.maxEnergy) {
                    gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + 1);
                    updateResources();
                }
            }, 10000); // æ¯10ç§’æ¢å¤1ç‚¹èƒ½é‡
            
            // éšæœºäº‹ä»¶è§¦å‘
            setInterval(() => {
                if (Math.random() < 0.1) { // 10%æ¦‚ç‡
                    triggerRandomEvent('general');
                }
            }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        }
        
        // åˆ›å»ºæ€ªå…½
        function createMonster(type, parent1 = null, parent2 = null) {
            const typeData = monsterTypes[type];
            const baseStats = typeData.baseStats;
            
            // åŸºç¡€å±æ€§ + éšæœºå˜å¼‚
            const stats = {};
            Object.keys(baseStats).forEach(stat => {
                let value = baseStats[stat];
                
                // å¦‚æœæ˜¯ç¹æ®–äº§ç”Ÿï¼Œç»§æ‰¿çˆ¶æ¯å±æ€§
                if (parent1 && parent2) {
                    const parent1Stat = parent1.stats[stat];
                    const parent2Stat = parent2.stats[stat];
                    value = Math.floor((parent1Stat + parent2Stat) / 2);
                    
                    // 20%æ¦‚ç‡çªå˜
                    if (Math.random() < 0.2) {
                        value += Math.random() < 0.5 ? -1 : 1;
                    }
                }
                
                // éšæœºå˜å¼‚ Â±20%
                value += Math.floor((Math.random() - 0.5) * 2 * (value * 0.2));
                stats[stat] = Math.max(1, value);
            });
            
            const monster = {
                id: gameState.nextMonsterId++,
                type: type,
                name: `${typeData.name}#${gameState.nextMonsterId}`,
                stats: stats,
                level: 1,
                exp: 0,
                maxExp: 100,
                assignment: null, // { type: 'farm'|'exploration'|'selling', target: id }
                status: 'idle', // idle, working, exploring, breeding
                traits: generateTraits(),
                generation: parent1 ? Math.max(parent1.generation, parent2.generation) + 1 : 1
            };
            
            gameState.monsters.push(monster);
            return monster;
        }
        
        // ç”Ÿæˆç‰¹æ€§
        function generateTraits() {
            const allTraits = [
                { id: 'fast', name: 'æ•æ·', effect: { agility: 1 } },
                { id: 'strong', name: 'å¼ºå£®', effect: { strength: 1 } },
                { id: 'smart', name: 'èªæ…§', effect: { intelligence: 1 } },
                { id: 'farmer', name: 'å†œå¤«', effect: { farming: 2 } },
                { id: 'lazy', name: 'æ‡’æƒ°', effect: { farming: -1, agility: -1 } },
                { id: 'lucky', name: 'å¹¸è¿', effect: { luck: 1 } },
                { id: 'hardy', name: 'é¡½å¼º', effect: { strength: 1, agility: -1 } }
            ];
            
            const numTraits = Math.random() < 0.3 ? 2 : 1;
            const traits = [];
            
            for (let i = 0; i < numTraits; i++) {
                const trait = allTraits[Math.floor(Math.random() * allTraits.length)];
                if (!traits.find(t => t.id === trait.id)) {
                    traits.push(trait);
                }
            }
            
            return traits;
        }
        
        // æ¸²æŸ“æ‰€æœ‰
        function renderAll() {
            updateResources();
            renderFarm();
            renderMonsters();
            renderExploration();
            renderBreeding();
            renderTech();
            renderDisposal();
        }
        
        // æ›´æ–°èµ„æºæ˜¾ç¤º
        function updateResources() {
            const resources = [
                { label: 'é‡‘å¸', value: gameState.coins, icon: 'ğŸ’°' },
                { label: 'é£Ÿç‰©', value: gameState.food, icon: 'ğŸŒ¾' },
                { label: 'ææ–™', value: gameState.materials, icon: 'ğŸ”¨' },
                { label: 'ç ”ç©¶ç‚¹', value: gameState.research, icon: 'ğŸ”¬' },
                { label: 'èƒ½é‡', value: `${gameState.energy}/${gameState.maxEnergy}`, icon: 'âš¡' }
            ];
            
            const resourcesEl = document.getElementById('resources');
            if (!resourcesEl) return;
            resourcesEl.innerHTML = resources.map(r => `
                <div class="resource">
                    <div class="resource-label">${r.icon} ${r.label}</div>
                    <div class="resource-value">${r.value}</div>
                </div>
            `).join('');
        }
        
        // æ¸²æŸ“å†œåœº
        function renderFarm() {
            const farmGrid = document.getElementById('farmGrid');
            if (!farmGrid) return;
            farmGrid.innerHTML = gameState.plots.map(plot => {
                if (plot.locked) {
                    return `
                        <div class="plot locked" onclick="unlockPlot(${plot.id})">
                            ${createSVG('lock', 48)}
                            <div class="plot-text">
                                è§£é”éœ€è¦:<br>
                                ğŸ’°${plot.unlockCost.coins}<br>
                                ğŸ”¨${plot.unlockCost.materials}
                            </div>
                        </div>
                    `;
                }
                
                if (plot.crop) {
                    const cropType = cropTypes.find(c => c.id === plot.crop);
                    const isReady = plot.progress >= 100;
                    
                    return `
                        <div class="plot planted ${isReady ? 'ready' : ''}" 
                             onclick="${isReady ? `harvest(${plot.id})` : ''}"
                             style="${isReady ? 'animation: pulse 1s infinite;' : ''}">
                            ${createSVG('plant', 48)}
                            <div class="plot-text">${cropType.name}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${plot.progress}%"></div>
                            </div>
                            ${plot.assignedMonster ? `
                                <div style="margin-top: 5px;">
                                    ${createSVG(plot.assignedMonster.type, 24)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="plot" onclick="showPlantMenu(${plot.id})">
                        ${createSVG('add', 48)}
                        <div class="plot-text">ç‚¹å‡»ç§æ¤</div>
                    </div>
                `;
            }).join('');
        }
        
        // åˆ›å»ºSVGå›¾æ ‡
        function createSVG(type, size = 48) {
            const svgs = {
                lock: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>`,
                
                add: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>`,
                
                plant: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2">
                    <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/>
                    <path d="M12 2v20"/>
                </svg>`,
                
                slime: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24">
                    <ellipse cx="12" cy="16" rx="8" ry="6" fill="#4caf50" opacity="0.8"/>
                    <circle cx="9" cy="14" r="1.5" fill="#fff"/>
                    <circle cx="15" cy="14" r="1.5" fill="#fff"/>
                    <circle cx="9" cy="14" r="0.7" fill="#000"/>
                    <circle cx="15" cy="14" r="0.7" fill="#000"/>
                </svg>`,
                
                goblin: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="7" fill="#ff9800" opacity="0.8"/>
                    <polygon points="8,8 9,5 11,8" fill="#ff9800"/>
                    <polygon points="16,8 15,5 13,8" fill="#ff9800"/>
                    <circle cx="9" cy="12" r="1.2" fill="#fff"/>
                    <circle cx="15" cy="12" r="1.2" fill="#fff"/>
                    <circle cx="9" cy="12" r="0.6" fill="#000"/>
                    <circle cx="15" cy="12" r="0.6" fill="#000"/>
                    <path d="M 9 15 Q 12 17 15 15" stroke="#000" stroke-width="1" fill="none"/>
                </svg>`,
                
                sprite: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="6" fill="#2196f3" opacity="0.6"/>
                    <path d="M 8 10 L 6 8 L 8 9" stroke="#2196f3" stroke-width="1.5" fill="none"/>
                    <path d="M 16 10 L 18 8 L 16 9" stroke="#2196f3" stroke-width="1.5" fill="none"/>
                    <circle cx="10" cy="11" r="1" fill="#fff"/>
                    <circle cx="14" cy="11" r="1" fill="#fff"/>
                    <path d="M 10 14 Q 12 15 14 14" stroke="#fff" stroke-width="1" fill="none"/>
                </svg>`,
                
                golem: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24">
                    <rect x="7" y="7" width="10" height="12" fill="#795548" opacity="0.8" rx="2"/>
                    <rect x="8" y="10" width="2" height="2" fill="#ffeb3b"/>
                    <rect x="14" y="10" width="2" height="2" fill="#ffeb3b"/>
                    <rect x="10" y="15" width="4" height="1" fill="#000"/>
                </svg>`,
                
                wisp: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="6" fill="#9c27b0" opacity="0.5"/>
                    <circle cx="12" cy="10" r="4" fill="#ce93d8" opacity="0.7"/>
                    <circle cx="10" cy="10" r="1" fill="#fff"/>
                    <circle cx="14" cy="10" r="1" fill="#fff"/>
                    <path d="M 10 18 Q 12 20 14 18" stroke="#9c27b0" stroke-width="1" fill="none" opacity="0.5"/>
                </svg>`,
                
                explore: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                </svg>`,
                
                breeding: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>`,
                
                recycle: `<svg class="svg-icon" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                    <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                    <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>`
            };
            
            return svgs[type] || svgs.slime;
        }
        
        // æ¸²æŸ“æ€ªå…½
        function renderMonsters() {
            const monsterGrid = document.getElementById('monsterGrid');
            if (!monsterGrid) return;
            
            if (gameState.monsters.length === 0) {
                monsterGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">è¿˜æ²¡æœ‰æ€ªå…½ï¼Œå»æ‹›å‹Ÿä¸€äº›å§ï¼</div>';
                return;
            }
            
            monsterGrid.innerHTML = gameState.monsters.map(monster => {
                const typeData = monsterTypes[monster.type];
                const isSelected = gameState.selectedMonster === monster.id;
                const isWorking = monster.status !== 'idle';
                
                return `
                    <div class="monster-card ${isWorking ? 'working' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectMonster(${monster.id})">
                        <div class="monster-header">
                            <div class="monster-icon-container">
                                ${createSVG(monster.type, 48)}
                            </div>
                            <div class="monster-info">
                                <div class="monster-name">${monster.name}</div>
                                <div class="monster-type" style="background: ${typeData.color}; color: white;">
                                    ${typeData.name} Gen.${monster.generation}
                                </div>
                            </div>
                        </div>
                        
                        <div class="monster-stats">
                            <div class="stat">
                                <span class="stat-label">åŠ›é‡</span>
                                <span class="stat-value">${monster.stats.strength}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">æ•æ·</span>
                                <span class="stat-value">${monster.stats.agility}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">æ™ºåŠ›</span>
                                <span class="stat-value">${monster.stats.intelligence}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">è€•ä½œ</span>
                                <span class="stat-value">${monster.stats.farming}</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 11px;">
                            <div style="color: #666; margin-bottom: 3px;">ç‰¹æ€§: ${monster.traits.map(t => t.name).join(', ')}</div>
                            <div style="color: #666;">ç­‰çº§: ${monster.level} (${monster.exp}/${monster.maxExp})</div>
                            ${isWorking ? `<div style="color: #2196f3; font-weight: bold; margin-top: 5px;">âš™ï¸ ${getStatusText(monster.status)}</div>` : ''}
                        </div>
                        
                        ${isSelected ? `
                            <div style="margin-top: 10px; display: flex; gap: 5px;">
                                <button class="btn btn-primary" style="flex:1; padding: 5px; font-size: 11px;" 
                                        onclick="event.stopPropagation(); assignToFarm(${monster.id})">
                                    è€•ä½œ
                                </button>
                                <button class="btn btn-warning" style="flex:1; padding: 5px; font-size: 11px;" 
                                        onclick="event.stopPropagation(); assignToSelling(${monster.id})">
                                    å”®å–
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                idle: 'ç©ºé—²',
                working: 'å·¥ä½œä¸­',
                exploring: 'æ¢ç´¢ä¸­',
                breeding: 'ç¹æ®–ä¸­',
                selling: 'å”®å–ä¸­'
            };
            return statusMap[status] || status;
        }
        
        // é€‰æ‹©æ€ªå…½
        function selectMonster(monsterId) {
            gameState.selectedMonster = gameState.selectedMonster === monsterId ? null : monsterId;
            renderMonsters();
        }
        
        // åˆ†é…åˆ°å†œåœº
        function assignToFarm(monsterId) {
            const monster = gameState.monsters.find(m => m.id === monsterId);
            if (!monster) return;
            
            if (monster.status !== 'idle') {
                showNotification('è¯¥æ€ªå…½æ­£åœ¨å¿™ç¢Œä¸­ï¼', 'warning');
                return;
            }
            
            // æ‰¾åˆ°å·²ç§æ¤ä½†æ²¡æœ‰åˆ†é…æ€ªå…½çš„åœ°å—
            const availablePlot = gameState.plots.find(p => p.crop && !p.assignedMonster && !p.locked);
            
            if (!availablePlot) {
                showNotification('æ²¡æœ‰å¯åˆ†é…çš„å†œç”°ï¼è¯·å…ˆç§æ¤ä½œç‰©', 'warning');
                return;
            }
            
            // åˆ†é…æ€ªå…½
            availablePlot.assignedMonster = monster;
            monster.assignment = { type: 'farm', target: availablePlot.id };
            monster.status = 'working';
            
            showNotification(`${monster.name} å¼€å§‹åœ¨å†œç”°å·¥ä½œï¼`, 'success');
            renderAll();
            
            // è§¦å‘å†œåœºäº‹ä»¶
            if (Math.random() < 0.15) {
                setTimeout(() => triggerRandomEvent('farming'), 2000);
            }
        }
        
        // åˆ†é…åˆ°å”®å–
        function assignToSelling(monsterId) {
            const monster = gameState.monsters.find(m => m.id === monsterId);
            if (!monster) return;
            
            if (monster.status !== 'idle') {
                showNotification('è¯¥æ€ªå…½æ­£åœ¨å¿™ç¢Œä¸­ï¼', 'warning');
                return;
            }
            
            if (gameState.food < 10) {
                showNotification('é£Ÿç‰©ä¸è¶³ï¼éœ€è¦10é£Ÿç‰©', 'error');
                return;
            }
            
            gameState.food -= 10;
            monster.status = 'selling';
            
            showNotification(`${monster.name} å‡ºé—¨å”®å–äº†...`, 'success');
            
            // å”®å–éœ€è¦30ç§’
            setTimeout(() => {
                const earnings = 20 + Math.floor(Math.random() * 30) + monster.stats.intelligence * 2;
                gameState.coins += earnings;
                
                // è·å¾—ç»éªŒ
                gainExp(monster, 15);
                
                monster.status = 'idle';
                updateResources();
                renderMonsters();
                showNotification(`${monster.name} å›æ¥äº†ï¼èµšäº† ${earnings} é‡‘å¸`, 'success');
            }, 30000);
            
            renderAll();
        }
        
        // è§£é”åœ°å—
        function unlockPlot(plotId) {
            const plot = gameState.plots[plotId];
            if (!plot.locked) return;
            
            const cost = plot.unlockCost;
            
            if (gameState.coins >= cost.coins && gameState.materials >= cost.materials) {
                if (confirm(`è§£é”è¿™å—å†œç”°éœ€è¦ï¼š\nğŸ’° ${cost.coins} é‡‘å¸\nğŸ”¨ ${cost.materials} ææ–™\n\nç¡®å®šè§£é”å—ï¼Ÿ`)) {
                    gameState.coins -= cost.coins;
                    gameState.materials -= cost.materials;
                    plot.locked = false;
                    
                    showNotification('è§£é”æˆåŠŸï¼', 'success');
                    renderAll();
                }
            } else {
                showNotification('èµ„æºä¸è¶³ï¼', 'error');
            }
        }
        
        // æ˜¾ç¤ºç§æ¤èœå•
        function showPlantMenu(plotId) {
            const plot = gameState.plots[plotId];
            if (plot.locked || plot.crop) return;
            
            const availableCrops = cropTypes.filter(crop => 
                !crop.requiredTech || gameState.technologies[crop.requiredTech]
            );
            
            const modalContent = `
                <div class="modal-header">é€‰æ‹©è¦ç§æ¤çš„ä½œç‰©</div>
                <div style="display: grid; gap: 10px;">
                    ${availableCrops.map(crop => `
                        <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; cursor: pointer; border: 2px solid #ddd;"
                             onclick="plantCrop(${plotId}, '${crop.id}')"
                             onmouseover="this.style.borderColor='#667eea'"
                             onmouseout="this.style.borderColor='#ddd'">
                            <div style="font-weight: bold; margin-bottom: 5px;">${crop.name}</div>
                            <div style="font-size: 12px; color: #666;">
                                ç”Ÿé•¿æ—¶é—´: ${crop.growTime/1000}ç§’<br>
                                äº§é‡: ${crop.yield} é£Ÿç‰©<br>
                                å”®ä»·: ${crop.value} é‡‘å¸
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // ç§æ¤ä½œç‰©
        function plantCrop(plotId, cropId) {
            const plot = gameState.plots[plotId];
            const cropType = cropTypes.find(c => c.id === cropId);
            
            closeModal();
            
            plot.crop = cropId;
            plot.plantedAt = Date.now();
            plot.progress = 0;
            
            showNotification(`ç§æ¤äº† ${cropType.name}`, 'success');
            renderFarm();
            
            // å¼€å§‹ç”Ÿé•¿
            growCrop(plotId);
        }
        
        // ä½œç‰©ç”Ÿé•¿
        function growCrop(plotId) {
            const plot = gameState.plots[plotId];
            if (!plot.crop) return;
            
            const cropType = cropTypes.find(c => c.id === plot.crop);
            
            const growInterval = setInterval(() => {
                if (!plot.crop) {
                    clearInterval(growInterval);
                    return;
                }
                
                // è®¡ç®—ç”Ÿé•¿é€Ÿåº¦
                let speedMultiplier = 1;
                
                // æ€ªå…½åŠ æˆ
                if (plot.assignedMonster) {
                    speedMultiplier *= (1 + plot.assignedMonster.stats.farming * 0.1);
                }
                
                // ç§‘æŠ€åŠ æˆ
                if (gameState.technologies.irrigation) {
                    speedMultiplier *= technologies.irrigation.effects.growthSpeed;
                }
                
                // ä¸´æ—¶buff
                speedMultiplier *= plot.growthBonus;
                
                const elapsed = Date.now() - plot.plantedAt;
                plot.progress = Math.min(100, (elapsed / cropType.growTime) * 100 * speedMultiplier);
                
                renderFarm();
                
                if (plot.progress >= 100) {
                    clearInterval(growInterval);
                    showNotification(`${cropType.name} æˆç†Ÿäº†ï¼`, 'success');
                    
                    // æ€ªå…½è·å¾—ç»éªŒ
                    if (plot.assignedMonster) {
                        gainExp(plot.assignedMonster, 10);
                    }
                }
            }, 100);
        }
        
        // æ”¶è·ä½œç‰©
        function harvest(plotId) {
            const plot = gameState.plots[plotId];
            if (!plot.crop || plot.progress < 100) return;
            
            const cropType = cropTypes.find(c => c.id === plot.crop);
            
            let yieldAmount = cropType.yield;
            let valueAmount = cropType.value;
            
            // ç§‘æŠ€åŠ æˆ
            if (gameState.technologies.advancedFarming) {
                yieldAmount *= technologies.advancedFarming.effects.cropYield;
                valueAmount *= technologies.advancedFarming.effects.cropYield;
            }
            
            yieldAmount = Math.floor(yieldAmount);
            valueAmount = Math.floor(valueAmount);
            
            gameState.food += yieldAmount;
            gameState.coins += valueAmount;
            gameState.totalHarvests++;
            
            // æ¦‚ç‡è·å¾—ç ”ç©¶ç‚¹
            if (Math.random() < 0.3) {
                const research = Math.floor(Math.random() * 5) + 1;
                gameState.research += research;
            }
            
            showNotification(`æ”¶è· ${cropType.name}ï¼è·å¾— ${yieldAmount} é£Ÿç‰©å’Œ ${valueAmount} é‡‘å¸`, 'success');
            
            // æ¸…ç©ºåœ°å—
            const assignedMonster = plot.assignedMonster;
            if (assignedMonster) {
                assignedMonster.status = 'idle';
                assignedMonster.assignment = null;
            }
            
            plot.crop = null;
            plot.plantedAt = null;
            plot.progress = 0;
            plot.assignedMonster = null;
            
            renderAll();
        }
        
        // æ€ªå…½è·å¾—ç»éªŒ
        function gainExp(monster, amount) {
            monster.exp += amount;
            
            while (monster.exp >= monster.maxExp) {
                monster.exp -= monster.maxExp;
                monster.level++;
                monster.maxExp = Math.floor(monster.maxExp * 1.5);
                
                // å‡çº§å±æ€§æå‡
                const statKeys = Object.keys(monster.stats);
                statKeys.forEach(key => {
                    const increase = Math.random() < 0.5 ? 1 : 0;
                    monster.stats[key] += increase;
                });
                
                showNotification(`${monster.name} å‡çº§åˆ° ${monster.level} çº§ï¼`, 'success');
            }
        }
        
        // æ¸²æŸ“æ¢ç´¢
        function renderExploration() {
            const explorationArea = document.getElementById('explorationArea');
            if (!explorationArea) return;
            
            explorationArea.innerHTML = `
                <h2>é‡å¤–æ¢ç´¢</h2>
                <p style="color: #666; margin: 10px 0;">æ´¾é£æ€ªå…½æ¢ç´¢é‡å¤–ï¼Œè·å–èµ„æºå’Œæ–°æ€ªå…½</p>
                
                <div class="expedition-panel">
                    <h3>å½“å‰æ¢é™©é˜Ÿ</h3>
                    <div class="expedition-slots" id="expeditionSlots"></div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="addToExpedition()">
                            æ·»åŠ æ€ªå…½
                        </button>
                        <button class="btn btn-success" onclick="startExpedition()" id="startExpeditionBtn">
                            å¼€å§‹æ¢ç´¢ (æ¶ˆè€—20èƒ½é‡)
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 20px; background: #f5f5f5; padding: 15px; border-radius: 10px;">
                    <h3>æ¢ç´¢è®°å½•</h3>
                    <div id="expeditionHistory" style="max-height: 200px; overflow-y: auto;">
                        ${gameState.totalExplorations === 0 ? 
                            '<div style="color: #999; text-align: center; padding: 20px;">è¿˜æ²¡æœ‰æ¢ç´¢è®°å½•</div>' : 
                            'å†å²è®°å½•æ˜¾ç¤ºåœ¨è¿™é‡Œ'}
                    </div>
                </div>
            `;
            
            renderExpeditionSlots();
        }
        
        // æ¸²æŸ“æ¢é™©æ§½ä½
        function renderExpeditionSlots() {
            const slots = document.getElementById('expeditionSlots');
            if (!slots) return;
            
            const maxSlots = 4;
            const currentExpedition = gameState.expeditions[0] || { members: [] };
            
            slots.innerHTML = Array(maxSlots).fill(0).map((_, i) => {
                const monster = currentExpedition.members[i];
                
                if (monster) {
                    return `
                        <div class="expedition-slot filled" onclick="removeFromExpedition(${i})">
                            ${createSVG(monster.type, 60)}
                            <div style="font-size: 10px; margin-top: 5px;">${monster.name}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="expedition-slot">
                        ${createSVG('add', 40)}
                    </div>
                `;
            }).join('');
        }
        
        // æ·»åŠ åˆ°æ¢é™©é˜Ÿ
        function addToExpedition() {
            if (!gameState.expeditions[0]) {
                gameState.expeditions[0] = { members: [], status: 'preparing' };
            }
            
            const expedition = gameState.expeditions[0];
            
            if (expedition.members.length >= 4) {
                showNotification('æ¢é™©é˜Ÿå·²æ»¡ï¼', 'warning');
                return;
            }
            
            if (expedition.status === 'exploring') {
                showNotification('æ¢é™©é˜Ÿæ­£åœ¨æ¢ç´¢ä¸­ï¼', 'warning');
                return;
            }
            
            const availableMonsters = gameState.monsters.filter(m => 
                m.status === 'idle' && !expedition.members.find(em => em.id === m.id)
            );
            
            if (availableMonsters.length === 0) {
                showNotification('æ²¡æœ‰å¯ç”¨çš„æ€ªå…½ï¼', 'warning');
                return;
            }
            
            const modalContent = `
                <div class="modal-header">é€‰æ‹©æ¢é™©æ€ªå…½</div>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${availableMonsters.map(monster => {
                        const typeData = monsterTypes[monster.type];
                        return `
                            <div style="padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 8px; cursor: pointer; border: 2px solid #ddd;"
                                 onclick="selectMonsterForExpedition(${monster.id})"
                                 onmouseover="this.style.borderColor='#667eea'"
                                 onmouseout="this.style.borderColor='#ddd'">
                                <div style="display: flex; align-items: center;">
                                    ${createSVG(monster.type, 40)}
                                    <div style="margin-left: 10px; flex: 1;">
                                        <div style="font-weight: bold;">${monster.name}</div>
                                        <div style="font-size: 11px; color: #666;">
                                            ${typeData.name} Lv.${monster.level} | 
                                            åŠ›é‡:${monster.stats.strength} æ•æ·:${monster.stats.agility} æ™ºåŠ›:${monster.stats.intelligence}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // é€‰æ‹©æ€ªå…½åŠ å…¥æ¢é™©
        function selectMonsterForExpedition(monsterId) {
            const monster = gameState.monsters.find(m => m.id === monsterId);
            const expedition = gameState.expeditions[0];
            
            expedition.members.push(monster);
            monster.status = 'preparing';
            
            closeModal();
            renderExpeditionSlots();
            showNotification(`${monster.name} åŠ å…¥æ¢é™©é˜Ÿï¼`, 'success');
        }
        
        // ä»æ¢é™©é˜Ÿç§»é™¤
        function removeFromExpedition(index) {
            const expedition = gameState.expeditions[0];
            if (!expedition || expedition.status === 'exploring') return;
            
            const monster = expedition.members[index];
            if (monster) {
                monster.status = 'idle';
                expedition.members.splice(index, 1);
                renderExpeditionSlots();
                showNotification(`${monster.name} ç¦»å¼€æ¢é™©é˜Ÿ`, 'success');
            }
        }
        
        // å¼€å§‹æ¢é™©
        function startExpedition() {
            const expedition = gameState.expeditions[0];
            
            if (!expedition || expedition.members.length === 0) {
                showNotification('æ¢é™©é˜Ÿæ˜¯ç©ºçš„ï¼', 'warning');
                return;
            }
            
            if (gameState.energy < 20) {
                showNotification('èƒ½é‡ä¸è¶³ï¼éœ€è¦20ç‚¹èƒ½é‡', 'error');
                return;
            }
            
            gameState.energy -= 20;
            expedition.status = 'exploring';
            expedition.startTime = Date.now();
            
            expedition.members.forEach(m => m.status = 'exploring');
            
            updateResources();
            showNotification('æ¢é™©é˜Ÿå‡ºå‘äº†ï¼', 'success');
            
            // æ¢é™©éœ€è¦60ç§’
            const expeditionTime = 60000;
            
            setTimeout(() => {
                completeExpedition();
            }, expeditionTime);
            
            // æ¢é™©è¿‡ç¨‹ä¸­å¯èƒ½è§¦å‘äº‹ä»¶
            setTimeout(() => {
                if (Math.random() < 0.4) {
                    triggerRandomEvent('exploration');
                }
            }, expeditionTime / 2);
        }
        
        // å®Œæˆæ¢é™©
        function completeExpedition() {
            const expedition = gameState.expeditions[0];
            if (!expedition || expedition.status !== 'exploring') return;
            
            // è®¡ç®—æ¢é™©æ”¶ç›Š
            let totalStrength = 0;
            let totalAgility = 0;
            let totalIntelligence = 0;
            
            expedition.members.forEach(m => {
                totalStrength += m.stats.strength;
                totalAgility += m.stats.agility;
                totalIntelligence += m.stats.intelligence;
            });
            
            const teamPower = totalStrength + totalAgility + totalIntelligence;
            
            // åŸºç¡€å¥–åŠ±
            let coinsReward = 50 + Math.floor(Math.random() * 100) + teamPower * 5;
            let materialsReward = 20 + Math.floor(Math.random() * 50) + Math.floor(teamPower * 0.5);
            let researchReward = 10 + Math.floor(Math.random() * 20) + Math.floor(totalIntelligence * 2);
            
            // ç§‘æŠ€åŠ æˆ
            if (gameState.technologies.exploration) {
                coinsReward = Math.floor(coinsReward * technologies.exploration.effects.explorationBonus);
                materialsReward = Math.floor(materialsReward * technologies.exploration.effects.explorationBonus);
                researchReward = Math.floor(researchReward * technologies.exploration.effects.explorationBonus);
            }
            
            gameState.coins += coinsReward;
            gameState.materials += materialsReward;
            gameState.research += researchReward;
            gameState.totalExplorations++;
            
            // æ€ªå…½è·å¾—ç»éªŒ
            expedition.members.forEach(m => {
                gainExp(m, 25 + Math.floor(Math.random() * 15));
                m.status = 'idle';
            });
            
            // æœ‰æœºä¼šå‘ç°æ–°æ€ªå…½
            if (Math.random() < 0.3) {
                const types = Object.keys(monsterTypes);
                const randomType = types[Math.floor(Math.random() * types.length)];
                const newMonster = createMonster(randomType);
                showNotification(`å‘ç°äº†é‡ç”Ÿçš„ ${newMonster.name}ï¼`, 'success');
            }
            
            showNotification(
                `æ¢é™©å®Œæˆï¼è·å¾—ï¼šğŸ’°${coinsReward} ğŸ”¨${materialsReward} ğŸ”¬${researchReward}`,
                'success'
            );
            
            // é‡ç½®æ¢é™©é˜Ÿ
            expedition.members = [];
            expedition.status = 'preparing';
            
            updateResources();
            renderExploration();
            renderMonsters();
        }
        
        // æ¸²æŸ“ç¹æ®–
        function renderBreeding() {
            const breedingContainer = document.getElementById('breedingContainer');
            if (!breedingContainer) return;
            
            if (!gameState.technologies.breeding) {
                breedingContainer.innerHTML = `
                    <h2>ç¹æ®–ä¸­å¿ƒ</h2>
                    <div style="text-align: center; padding: 60px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”’</div>
                        <div>éœ€è¦è§£é”"ç¹æ®–æŠ€æœ¯"æ‰èƒ½ä½¿ç”¨</div>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="switchTab('tech')">
                            å‰å¾€ç§‘æŠ€æ ‘
                        </button>
                    </div>
                `;
                return;
            }
            
            breedingContainer.innerHTML = `
                <h2>ç¹æ®–ä¸­å¿ƒ</h2>
                <p style="color: #666; margin: 10px 0;">é€‰æ‹©ä¸¤åªæ€ªå…½è¿›è¡Œç¹æ®–ï¼ŒåŸ¹è‚²æ›´å¼ºçš„åä»£</p>
                
                <div class="breeding-slots">
                    <div class="breeding-slot" id="breedSlot1" onclick="selectBreedingMonster(1)">
                        ${gameState.breedingSlot1 ? 
                            `${createSVG(gameState.breedingSlot1.type, 60)}
                            <div style="font-size: 12px; margin-top: 10px;">${gameState.breedingSlot1.name}</div>` :
                            `${createSVG('add', 60)}
                            <div style="font-size: 12px; margin-top: 10px;">é€‰æ‹©æ€ªå…½</div>`
                        }
                    </div>
                    
                    <div class="breeding-arrow">+</div>
                    
                    <div class="breeding-slot" id="breedSlot2" onclick="selectBreedingMonster(2)">
                        ${gameState.breedingSlot2 ? 
                            `${createSVG(gameState.breedingSlot2.type, 60)}
                            <div style="font-size: 12px; margin-top: 10px;">${gameState.breedingSlot2.name}</div>` :
                            `${createSVG('add', 60)}
                            <div style="font-size: 12px; margin-top: 10px;">é€‰æ‹©æ€ªå…½</div>`
                        }
                    </div>
                    
                    <div class="breeding-arrow">=</div>
                    
                    <div class="breeding-slot" style="border-color: #4caf50; background: #e8f5e9;">
                        ${createSVG('breeding', 60)}
                        <div style="font-size: 12px; margin-top: 10px;">åä»£</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="startBreeding()" 
                            ${!gameState.breedingSlot1 || !gameState.breedingSlot2 ? 'disabled' : ''}>
                        å¼€å§‹ç¹æ®– (æ¶ˆè€—100é£Ÿç‰©ï¼Œ30èƒ½é‡)
                    </button>
                    <button class="btn btn-primary" onclick="clearBreedingSlots()" 
                            style="margin-left: 10px;">
                        æ¸…ç©º
                    </button>
                </div>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <h3>ç¹æ®–è¯´æ˜</h3>
                    <ul style="margin-left: 20px; color: #666; font-size: 13px; line-height: 1.8;">
                        <li>åä»£ä¼šç»§æ‰¿çˆ¶æ¯çš„å¹³å‡å±æ€§</li>
                        <li>æœ‰20%æ¦‚ç‡å‘ç”Ÿå±æ€§çªå˜</li>
                        <li>åä»£ç±»å‹éšæœºç»§æ‰¿çˆ¶æ¯ä¹‹ä¸€</li>
                        <li>ç‰¹æ€§ä¼šéšæœºé—ä¼ </li>
                        <li>ä»£æ•°ä¸ºçˆ¶æ¯æœ€é«˜ä»£æ•°+1</li>
                    </ul>
                </div>
            `;
        }
        
        // é€‰æ‹©ç¹æ®–æ€ªå…½
        function selectBreedingMonster(slotNumber) {
            const availableMonsters = gameState.monsters.filter(m => 
                m.status === 'idle' && 
                m.id !== gameState.breedingSlot1?.id && 
                m.id !== gameState.breedingSlot2?.id
            );
            
            if (availableMonsters.length === 0) {
                showNotification('æ²¡æœ‰å¯ç”¨çš„æ€ªå…½ï¼', 'warning');
                return;
            }
            
            const modalContent = `
                <div class="modal-header">é€‰æ‹©æ€ªå…½ (æ§½ä½ ${slotNumber})</div>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${availableMonsters.map(monster => {
                        const typeData = monsterTypes[monster.type];
                        return `
                            <div style="padding: 10px; margin: 5px 0; background: #f5f5f5; border-radius: 8px; cursor: pointer; border: 2px solid #ddd;"
                                 onclick="assignBreedingMonster(${slotNumber}, ${monster.id})"
                                 onmouseover="this.style.borderColor='#667eea'"
                                 onmouseout="this.style.borderColor='#ddd'">
                                <div style="display: flex; align-items: center;">
                                    ${createSVG(monster.type, 40)}
                                    <div style="margin-left: 10px; flex: 1;">
                                        <div style="font-weight: bold;">${monster.name}</div>
                                        <div style="font-size: 11px; color: #666;">
                                            ${typeData.name} Lv.${monster.level} Gen.${monster.generation}
                                        </div>
                                        <div style="font-size: 10px; color: #999; margin-top: 3px;">
                                            åŠ›:${monster.stats.strength} æ•:${monster.stats.agility} 
                                            æ™º:${monster.stats.intelligence} å†œ:${monster.stats.farming}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // åˆ†é…ç¹æ®–æ€ªå…½
        function assignBreedingMonster(slotNumber, monsterId) {
            const monster = gameState.monsters.find(m => m.id === monsterId);
            
            if (slotNumber === 1) {
                gameState.breedingSlot1 = monster;
            } else {
                gameState.breedingSlot2 = monster;
            }
            
            monster.status = 'preparing';
            
            closeModal();
            renderBreeding();
            showNotification(`${monster.name} è¿›å…¥ç¹æ®–æ§½ä½`, 'success');
        }
        
        // æ¸…ç©ºç¹æ®–æ§½ä½
        function clearBreedingSlots() {
            if (gameState.breedingSlot1) {
                gameState.breedingSlot1.status = 'idle';
                gameState.breedingSlot1 = null;
            }
            if (gameState.breedingSlot2) {
                gameState.breedingSlot2.status = 'idle';
                gameState.breedingSlot2 = null;
            }
            renderBreeding();
        }
        
        // å¼€å§‹ç¹æ®–
        function startBreeding() {
            if (!gameState.breedingSlot1 || !gameState.breedingSlot2) {
                showNotification('è¯·é€‰æ‹©ä¸¤åªæ€ªå…½ï¼', 'warning');
                return;
            }
            
            if (gameState.food < 100) {
                showNotification('é£Ÿç‰©ä¸è¶³ï¼éœ€è¦100é£Ÿç‰©', 'error');
                return;
            }
            
            if (gameState.energy < 30) {
                showNotification('èƒ½é‡ä¸è¶³ï¼éœ€è¦30ç‚¹èƒ½é‡', 'error');
                return;
            }
            
            gameState.food -= 100;
            gameState.energy -= 30;
            
            const parent1 = gameState.breedingSlot1;
            const parent2 = gameState.breedingSlot2;
            
            parent1.status = 'breeding';
            parent2.status = 'breeding';
            
            showNotification('å¼€å§‹ç¹æ®–...', 'success');
            updateResources();
            
            // ç¹æ®–éœ€è¦45ç§’
            setTimeout(() => {
                // éšæœºé€‰æ‹©çˆ¶æ¯ä¹‹ä¸€çš„ç±»å‹
                const childType = Math.random() < 0.5 ? parent1.type : parent2.type;
                
                // åˆ›å»ºåä»£
                const child = createMonster(childType, parent1, parent2);
                
                parent1.status = 'idle';
                parent2.status = 'idle';
                
                gameState.breedingSlot1 = null;
                gameState.breedingSlot2 = null;
                gameState.monstersBreed++;
                
                showNotification(`ç¹æ®–æˆåŠŸï¼è·å¾—æ–°æ€ªå…½ï¼š${child.name}`, 'success');
                renderBreeding();
                renderMonsters();
            }, 45000);
        }
        
        // æ¸²æŸ“ç§‘æŠ€æ ‘
        function renderTech() {
            const techTree = document.getElementById('techTree');
            if (!techTree) return;
            
            techTree.innerHTML = Object.keys(technologies).map(techId => {
                const tech = technologies[techId];
                const unlocked = gameState.technologies[techId];
                
                const canUnlock = Object.keys(tech.cost).every(resource => {
                    return gameState[resource] >= tech.cost[resource];
                });
                
                return `
                    <div class="tech-item ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="tech-title">
                            ${unlocked ? 'âœ…' : 'ğŸ”’'} ${tech.name}
                        </div>
                        <div class="tech-desc">${tech.desc}</div>
                        ${!unlocked ? `
                            <div class="tech-cost">
                                éœ€è¦: ${Object.keys(tech.cost).map(r => 
                                    `${getResourceIcon(r)}${tech.cost[r]}`
                                ).join(' ')}
                            </div>
                            <button class="btn btn-primary" 
                                    onclick="unlockTech('${techId}')"
                                    ${!canUnlock ? 'disabled' : ''}>
                                ${canUnlock ? 'è§£é”' : 'èµ„æºä¸è¶³'}
                            </button>
                        ` : `
                            <div style="color: #4caf50; font-weight: bold; margin-top: 10px;">
                                âœ“ å·²è§£é”
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                ${Object.keys(tech.effects).map(e => 
                                    `${e}: ${tech.effects[e]}`
                                ).join(', ')}
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }
        
        // è·å–èµ„æºå›¾æ ‡
        function getResourceIcon(resource) {
            const icons = {
                coins: 'ğŸ’°',
                food: 'ğŸŒ¾',
                materials: 'ğŸ”¨',
                research: 'ğŸ”¬',
                energy: 'âš¡'
            };
            return icons[resource] || '';
        }
        
        // è§£é”ç§‘æŠ€
        function unlockTech(techId) {
            const tech = technologies[techId];
            
            const canUnlock = Object.keys(tech.cost).every(resource => {
                return gameState[resource] >= tech.cost[resource];
            });
            
            if (!canUnlock) {
                showNotification('èµ„æºä¸è¶³ï¼', 'error');
                return;
            }
            
            // æ‰£é™¤èµ„æº
            Object.keys(tech.cost).forEach(resource => {
                gameState[resource] -= tech.cost[resource];
            });
            
            gameState.technologies[techId] = true;
            
            // åº”ç”¨ç§‘æŠ€æ•ˆæœ
            if (techId === 'expansion') {
                // è§£é”é¢å¤–åœ°å—
                gameState.plots.slice(3, 3 + tech.effects.extraPlots).forEach(plot => {
                    plot.locked = false;
                });
            }
            
            showNotification(`æˆåŠŸè§£é”ï¼š${tech.name}ï¼`, 'success');
            updateResources();
            renderTech();
            renderFarm();
        }
        
        // æ¸²æŸ“å¤„ç†ç•Œé¢
        function renderDisposal() {
            const disposalContainer = document.getElementById('disposalContainer');
            if (!disposalContainer) return;
            
            disposalContainer.innerHTML = `
                <h2>æ€ªå…½å¤„ç†ä¸­å¿ƒ</h2>
                <p style="color: #666; margin: 10px 0;">ç®¡ç†å¤šä½™çš„æ€ªå…½ï¼ˆé€‰æ‹©æ€ªå…½åå¯è¿›è¡Œå¤„ç†ï¼‰</p>
                
                ${gameState.selectedMonster ? `
                    <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ff9800;">
                        <strong>å·²é€‰æ‹©ï¼š</strong> ${gameState.monsters.find(m => m.id === gameState.selectedMonster)?.name || 'æ— '}
                    </div>
                ` : `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; color: #999;">
                        è¯·å…ˆåœ¨"æ€ªå…½"æ ‡ç­¾é¡µé€‰æ‹©è¦å¤„ç†çš„æ€ªå…½
                    </div>
                `}
                
                <div class="disposal-options">
                    <div class="disposal-option" onclick="releaseMonster()">
                        <div style="font-size: 48px;">ğŸŒŠ</div>
                        <div class="disposal-title">æ”¾ç”Ÿ</div>
                        <div class="disposal-desc">
                            å°†æ€ªå…½æ”¾å½’è‡ªç„¶<br>
                            è·å¾—å°‘é‡ææ–™
                        </div>
                    </div>
                    
                    <div class="disposal-option" onclick="sacrificeMonster()">
                        <div style="font-size: 48px;">âš—ï¸</div>
                        <div class="disposal-title">çŒ®ç¥­</div>
                        <div class="disposal-desc">
                            çŒ®ç¥­æ€ªå…½<br>
                            è·å¾—å¤§é‡ç ”ç©¶ç‚¹
                        </div>
                    </div>
                    
                    <div class="disposal-option" onclick="decomposeMonster()">
                        <div style="font-size: 48px;">ğŸ”§</div>
                        <div class="disposal-title">åˆ†è§£</div>
                        <div class="disposal-desc">
                            åˆ†è§£æ€ªå…½<br>
                            è·å¾—ææ–™å’Œé£Ÿç‰©
                        </div>
                    </div>
                    
                    <div class="disposal-option" onclick="sellMonster()">
                        <div style="font-size: 48px;">ğŸ’¸</div>
                        <div class="disposal-title">å‡ºå”®</div>
                        <div class="disposal-desc">
                            å–ç»™å•†äºº<br>
                            è·å¾—å¤§é‡é‡‘å¸
                        </div>
                    </div>
                </div>
                
                <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #f44336;">
                    <strong>âš ï¸ è­¦å‘Šï¼š</strong> æ‰€æœ‰å¤„ç†æ“ä½œéƒ½æ˜¯ä¸å¯é€†çš„ï¼Œè¯·è°¨æ…æ“ä½œï¼
                </div>
            `;
        }
        
        // æ”¾ç”Ÿæ€ªå…½
        function releaseMonster() {
            if (!gameState.selectedMonster) {
                showNotification('è¯·å…ˆé€‰æ‹©æ€ªå…½ï¼', 'warning');
                return;
            }
            
            const monster = gameState.monsters.find(m => m.id === gameState.selectedMonster);
            
            if (monster.status !== 'idle') {
                showNotification('è¯¥æ€ªå…½æ­£åœ¨å·¥ä½œä¸­ï¼', 'warning');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ”¾ç”Ÿ ${monster.name} å—ï¼Ÿ\n\nè¿™å°†è·å¾— ${monster.level * 5} ææ–™`)) {
                const reward = monster.level * 5;
                gameState.materials += reward;
                
                // ç§»é™¤æ€ªå…½
                const index = gameState.monsters.findIndex(m => m.id === monster.id);
                gameState.monsters.splice(index, 1);
                
                gameState.selectedMonster = null;
                
                showNotification(`æ”¾ç”Ÿäº† ${monster.name}ï¼Œè·å¾— ${reward} ææ–™`, 'success');
                updateResources();
                renderMonsters();
                renderDisposal();
            }
        }
        
        // çŒ®ç¥­æ€ªå…½
        function sacrificeMonster() {
            if (!gameState.selectedMonster) {
                showNotification('è¯·å…ˆé€‰æ‹©æ€ªå…½ï¼', 'warning');
                return;
            }
            
            const monster = gameState.monsters.find(m => m.id === gameState.selectedMonster);
            
            if (monster.status !== 'idle') {
                showNotification('è¯¥æ€ªå…½æ­£åœ¨å·¥ä½œä¸­ï¼', 'warning');
                return;
            }
            
            const reward = monster.level * 10 + Object.values(monster.stats).reduce((a, b) => a + b, 0) * 2;
            
            if (confirm(`ç¡®å®šè¦çŒ®ç¥­ ${monster.name} å—ï¼Ÿ\n\nè¿™å°†è·å¾— ${reward} ç ”ç©¶ç‚¹\n\nâš ï¸ æ­¤æ“ä½œä¸å¯é€†ï¼`)) {
                gameState.research += reward;
                
                // ç§»é™¤æ€ªå…½
                const index = gameState.monsters.findIndex(m => m.id === monster.id);
                gameState.monsters.splice(index, 1);
                
                gameState.selectedMonster = null;
                
                showNotification(`çŒ®ç¥­äº† ${monster.name}ï¼Œè·å¾— ${reward} ç ”ç©¶ç‚¹`, 'success');
                updateResources();
                renderMonsters();
                renderDisposal();
            }
        }
        
        // åˆ†è§£æ€ªå…½
        function decomposeMonster() {
            if (!gameState.selectedMonster) {
                showNotification('è¯·å…ˆé€‰æ‹©æ€ªå…½ï¼', 'warning');
                return;
            }
            
            const monster = gameState.monsters.find(m => m.id === gameState.selectedMonster);
            
            if (monster.status !== 'idle') {
                showNotification('è¯¥æ€ªå…½æ­£åœ¨å·¥ä½œä¸­ï¼', 'warning');
                return;
            }
            
            const materialsReward = monster.level * 8 + monster.stats.strength * 3;
            const foodReward = monster.level * 5 + monster.stats.farming * 2;
            
            if (confirm(`ç¡®å®šè¦åˆ†è§£ ${monster.name} å—ï¼Ÿ\n\nå°†è·å¾—ï¼š\nğŸ”¨ ${materialsReward} ææ–™\nğŸŒ¾ ${foodReward} é£Ÿç‰©`)) {
                gameState.materials += materialsReward;
                gameState.food += foodReward;
                
                // ç§»é™¤æ€ªå…½
                const index = gameState.monsters.findIndex(m => m.id === monster.id);
                gameState.monsters.splice(index, 1);
                
                gameState.selectedMonster = null;
                
                showNotification(`åˆ†è§£äº† ${monster.name}`, 'success');
                updateResources();
                renderMonsters();
                renderDisposal();
            }
        }
        
        // å‡ºå”®æ€ªå…½
        function sellMonster() {
            if (!gameState.selectedMonster) {
                showNotification('è¯·å…ˆé€‰æ‹©æ€ªå…½ï¼', 'warning');
                return;
            }
            
            const monster = gameState.monsters.find(m => m.id === gameState.selectedMonster);
            
            if (monster.status !== 'idle') {
                showNotification('è¯¥æ€ªå…½æ­£åœ¨å·¥ä½œä¸­ï¼', 'warning');
                return;
            }
            
            const totalStats = Object.values(monster.stats).reduce((a, b) => a + b, 0);
            const reward = monster.level * 20 + totalStats * 5 + monster.generation * 10;
            
            if (confirm(`ç¡®å®šè¦å‡ºå”® ${monster.name} å—ï¼Ÿ\n\nå°†è·å¾— ${reward} é‡‘å¸`)) {
                gameState.coins += reward;
                
                // ç§»é™¤æ€ªå…½
                const index = gameState.monsters.findIndex(m => m.id === monster.id);
                gameState.monsters.splice(index, 1);
                
                gameState.selectedMonster = null;
                
                showNotification(`å‡ºå”®äº† ${monster.name}ï¼Œè·å¾— ${reward} é‡‘å¸`, 'success');
                updateResources();
                renderMonsters();
                renderDisposal();
            }
        }
        
        // è§¦å‘éšæœºäº‹ä»¶
        function triggerRandomEvent(category) {
            let eventPool = randomEvents[category] || [];
            
            if (eventPool.length === 0) {
                eventPool = randomEvents.general;
            }
            
            const event = eventPool[Math.floor(Math.random() * eventPool.length)];
            
            showEventPanel(event);
        }
        
        // æ˜¾ç¤ºäº‹ä»¶é¢æ¿
        function showEventPanel(event) {
            // ç§»é™¤æ—§äº‹ä»¶
            const oldEvent = document.querySelector('.event-panel');
            if (oldEvent) oldEvent.remove();
            
            const eventPanel = document.createElement('div');
            eventPanel.className = 'event-panel';
            
            eventPanel.innerHTML = `
                <div class="event-title">${event.title}</div>
                <div class="event-desc">${event.desc}</div>
                <div class="event-choices">
                    ${event.choices.map((choice, index) => {
                        const canAfford = !choice.cost || Object.keys(choice.cost).every(r => 
                            gameState[r] >= choice.cost[r]
                        );
                        
                        return `
                            <button class="btn ${index === 0 ? 'btn-primary' : 'btn-warning'}" 
                                    onclick="handleEventChoice(${index}, ${JSON.stringify(event).replace(/"/g, '&quot;')})"
                                    ${!canAfford ? 'disabled' : ''}>
                                ${choice.text}
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.body.appendChild(eventPanel);
            
            // 30ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (eventPanel.parentNode) {
                    eventPanel.remove();
                }
            }, 30000);
        }
        
        // å¤„ç†äº‹ä»¶é€‰æ‹©
        function handleEventChoice(choiceIndex, event) {
            const choice = event.choices[choiceIndex];
            
            // æ‰£é™¤æˆæœ¬
            if (choice.cost) {
                Object.keys(choice.cost).forEach(resource => {
                    gameState[resource] -= choice.cost[resource];
                });
            }
            
            // æ‰§è¡Œæ•ˆæœ
            if (choice.effect) {
                choice.effect();
            }
            
            // ç§»é™¤äº‹ä»¶é¢æ¿
            const eventPanel = document.querySelector('.event-panel');
            if (eventPanel) eventPanel.remove();
            
            updateResources();
        }
        
        // æ˜¾ç¤ºæ‹›å‹Ÿæ¨¡æ€æ¡†
        function showRecruitModal() {
            const recruitOptions = Object.keys(monsterTypes).map(typeId => {
                const typeData = monsterTypes[typeId];
                const baseCost = 50;
                const typeCosts = {
                    slime: 50,
                    goblin: 80,
                    sprite: 120,
                    golem: 150,
                    wisp: 200
                };
                const cost = typeCosts[typeId] || baseCost;
                
                return `
                    <div style="padding: 15px; margin: 10px 0; background: #f5f5f5; border-radius: 10px; border: 2px solid #ddd; cursor: pointer;"
                         onclick="recruitMonster('${typeId}', ${cost})"
                         onmouseover="this.style.borderColor='${typeData.color}'"
                         onmouseout="this.style.borderColor='#ddd'">
                        <div style="display: flex; align-items: center;">
                            ${createSVG(typeId, 50)}
                            <div style="margin-left: 15px; flex: 1;">
                                <div style="font-weight: bold; font-size: 16px; color: ${typeData.color};">
                                    ${typeData.name}
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    åŸºç¡€å±æ€§ï¼š
                                    åŠ›é‡ ${typeData.baseStats.strength} | 
                                    æ•æ· ${typeData.baseStats.agility} | 
                                    æ™ºåŠ› ${typeData.baseStats.intelligence} | 
                                    è€•ä½œ ${typeData.baseStats.farming}
                                </div>
                                <div style="font-size: 14px; color: #ff9800; margin-top: 8px; font-weight: bold;">
                                    ğŸ’° ${cost} é‡‘å¸
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const modalContent = `
                <div class="modal-header">æ‹›å‹Ÿæ€ªå…½</div>
                <div style="max-height: 500px; overflow-y: auto;">
                    ${recruitOptions}
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // æ‹›å‹Ÿæ€ªå…½
        function recruitMonster(typeId, cost) {
            if (gameState.coins < cost) {
                showNotification('é‡‘å¸ä¸è¶³ï¼', 'error');
                return;
            }
            
            if (gameState.monsters.length >= 20) {
                showNotification('æ€ªå…½æ•°é‡å·²è¾¾ä¸Šé™ï¼ˆ20åªï¼‰ï¼', 'warning');
                return;
            }
            
            gameState.coins -= cost;
            const monster = createMonster(typeId);
            
            closeModal();
            showNotification(`æˆåŠŸæ‹›å‹Ÿ ${monster.name}ï¼`, 'success');
            updateResources();
            renderMonsters();
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = content;
            modal.classList.add('active');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // åˆ·æ–°å¯¹åº”å†…å®¹
            switch(tabName) {
                case 'farm':
                    renderFarm();
                    break;
                case 'monsters':
                    renderMonsters();
                    break;
                case 'exploration':
                    renderExploration();
                    break;
                case 'breeding':
                    renderBreeding();
                    break;
                case 'tech':
                    renderTech();
                    break;
                case 'disposal':
                    renderDisposal();
                    break;
            }
        }
        
        // è‡ªåŠ¨ä¿å­˜
        function autoSave() {
            const saveData = {
                coins: gameState.coins,
                food: gameState.food,
                materials: gameState.materials,
                research: gameState.research,
                energy: gameState.energy,
                monsters: gameState.monsters.map(m => ({
                    ...m,
                    assignment: null,
                    status: 'idle'
                })),
                technologies: gameState.technologies,
                plots: gameState.plots.map(p => ({
                    ...p,
                    crop: null,
                    assignedMonster: null,
                    progress: 0
                })),
                totalHarvests: gameState.totalHarvests,
                totalExplorations: gameState.totalExplorations,
                monstersBreed: gameState.monstersBreed,
                nextMonsterId: gameState.nextMonsterId
            };
            
            localStorage.setItem('monsterFarm_v1', JSON.stringify(saveData));
        }
        
        // åŠ è½½æ¸¸æˆ
        function loadGame() {
            const saved = localStorage.getItem('monsterFarm_v1');
            
            if (saved) {
                try {
                    const saveData = JSON.parse(saved);
                    
                    gameState.coins = saveData.coins || 100;
                    gameState.food = saveData.food || 50;
                    gameState.materials = saveData.materials || 0;
                    gameState.research = saveData.research || 0;
                    gameState.energy = saveData.energy || 100;
                    gameState.monsters = saveData.monsters || [];
                    gameState.technologies = saveData.technologies || {};
                    gameState.totalHarvests = saveData.totalHarvests || 0;
                    gameState.totalExplorations = saveData.totalExplorations || 0;
                    gameState.monstersBreed = saveData.monstersBreed || 0;
                    gameState.nextMonsterId = saveData.nextMonsterId || 1;
                    
                    // ç¡®ä¿ç§‘æŠ€çŠ¶æ€æ­£ç¡®
                    Object.keys(technologies).forEach(key => {
                        if (!(key in gameState.technologies)) {
                            gameState.technologies[key] = false;
                        }
                    });
                    
                    showNotification('æ¸¸æˆåŠ è½½æˆåŠŸï¼', 'success');
                } catch (e) {
                    console.error('åŠ è½½å­˜æ¡£å¤±è´¥:', e);
                    showNotification('åŠ è½½å­˜æ¡£å¤±è´¥ï¼Œå¼€å§‹æ–°æ¸¸æˆ', 'warning');
                }
            }
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ï¼')) {
                localStorage.removeItem('monsterFarm_v1');
                location.reload();
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // æ·»åŠ è„‰å†²åŠ¨ç”»
        const pulseStyle = document.createElement('style');
        pulseStyle.textContent = `
            @keyframes pulse {
                0%, 100% {
                    transform: scale(1);
                    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
                }
                50% {
                    transform: scale(1.05);
                    box-shadow: 0 8px 25px rgba(76, 175, 80, 0.5);
                }
            }
            
            .ready {
                animation: pulse 1.5s infinite;
            }
        `;
        document.head.appendChild(pulseStyle);
        
        // æ·»åŠ å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S ä¿å­˜
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                autoSave();
                showNotification('æ¸¸æˆå·²ä¿å­˜ï¼', 'success');
            }
            
            // Esc å…³é—­æ¨¡æ€æ¡†
            if (e.key === 'Escape') {
                closeModal();
            }
            
            // æ•°å­—é”®åˆ‡æ¢æ ‡ç­¾
            const tabMap = {
                '1': 'farm',
                '2': 'monsters',
                '3': 'exploration',
                '4': 'breeding',
                '5': 'tech',
                '6': 'disposal'
            };
            
            if (tabMap[e.key] && !e.ctrlKey && !e.metaKey) {
                const tabs = document.querySelectorAll('.tab');
                const index = parseInt(e.key) - 1;
                if (tabs[index]) {
                    tabs[index].click();
                }
            }
        });
        
        // è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        setInterval(() => {
            autoSave();
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
        
        // æ·»åŠ è®¾ç½®æŒ‰é’®åˆ°é¡µé¢
        const settingsButton = document.createElement('div');
        settingsButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s;
        `;
        settingsButton.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m8.66-7.5l-5.2 3m-5.2 3l-5.2-3M1.34 16.5l5.2-3m5.2-3l5.2-3"></path>
            </svg>
        `;
        
        settingsButton.addEventListener('click', () => {
            const modalContent = `
                <div class="modal-header">æ¸¸æˆè®¾ç½®</div>
                <div style="padding: 10px 0;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">ç»Ÿè®¡æ•°æ®</h3>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 13px;">
                            <div>æ€»æ”¶è·æ¬¡æ•°: ${gameState.totalHarvests}</div>
                            <div>æ€»æ¢ç´¢æ¬¡æ•°: ${gameState.totalExplorations}</div>
                            <div>ç¹æ®–æ€ªå…½æ•°: ${gameState.monstersBreed}</div>
                            <div>æ‹¥æœ‰æ€ªå…½æ•°: ${gameState.monsters.length}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">å¿«æ·é”®</h3>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 12px;">
                            <div>1-6: åˆ‡æ¢æ ‡ç­¾é¡µ</div>
                            <div>Ctrl/Cmd + S: æ‰‹åŠ¨ä¿å­˜</div>
                            <div>Esc: å…³é—­å¼¹çª—</div>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-success" onclick="autoSave(); showNotification('ä¿å­˜æˆåŠŸï¼', 'success'); closeModal();">
                        æ‰‹åŠ¨ä¿å­˜
                    </button>
                    <button class="btn btn-danger" onclick="resetGame()">
                        é‡ç½®æ¸¸æˆ
                    </button>
                    <button class="btn btn-primary" onclick="closeModal()">
                        å…³é—­
                    </button>
                </div>
            `;
            
            showModal(modalContent);
        });
        
        settingsButton.addEventListener('mouseenter', () => {
            settingsButton.style.transform = 'scale(1.1) rotate(45deg)';
        });
        
        settingsButton.addEventListener('mouseleave', () => {
            settingsButton.style.transform = 'scale(1) rotate(0deg)';
        });
        
        document.body.appendChild(settingsButton);
        
        // æ¸¸æˆåˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadGame();
            initGame();
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            setTimeout(() => {
                showNotification('æ¬¢è¿æ¥åˆ°æ€ªå…½å†œåœºï¼å¼€å§‹ä½ çš„å†’é™©å§ï¼', 'success');
            }, 500);
        });
        
        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            autoSave();
        });
    </script>
</body>
</html>